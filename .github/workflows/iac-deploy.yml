# Pipeline 1: Infrastructure-as-Code (IaC) deployment.
# Securely deploys the exercise as IaC: validate + scan IaC, then plan and apply.
# Security: IaC is validated and (optionally) scanned before deploy; runs apply only on push to main.
#
# Required secrets: GCP_SA_KEY, GCP_PROJECT_ID
# Optional: TF_STATE_BUCKET (default: $GCP_PROJECT_ID-tfstate-wiz-exercise)

name: IaC Deploy

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/iac-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/iac-deploy.yml'
  workflow_dispatch:

env:
  TF_WORKING_DIR: terraform

jobs:
  validate:
    name: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Terraform Init (no backend)
        run: terraform init -backend=false
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: IaC security scan (tfsec)
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" aquasec/tfsec:latest /src/${{ env.TF_WORKING_DIR }} --minimum-severity HIGH --no-color 2>/dev/null || true
        continue-on-error: true

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write

    env:
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET || format('{0}-tfstate-wiz-exercise', secrets.GCP_PROJECT_ID) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Terraform Init (GCS backend)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        run: terraform plan -input=false -out=tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}
