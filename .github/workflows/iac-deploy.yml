# Pipeline 1: Infrastructure-as-Code (IaC) deployment.
# Securely deploys the exercise as IaC: validate + scan IaC, then plan and apply.
# Security: IaC is validated and (optionally) scanned before deploy; runs apply only on push to main.
#
# Required secrets: GCP_SA_KEY, GCP_PROJECT_ID
# Optional: TF_STATE_BUCKET (default: $GCP_PROJECT_ID-tfstate-wiz-exercise)

name: IaC Deploy

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/iac-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/iac-deploy.yml'
  workflow_dispatch:

env:
  TF_WORKING_DIR: terraform

jobs:
  validate:
    name: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Terraform Init (no backend)
        run: terraform init -backend=false
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: IaC security scan (tfsec)
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" aquasec/tfsec:latest /src/${{ env.TF_WORKING_DIR }} --minimum-severity HIGH --no-color 2>/dev/null || true
        continue-on-error: true

  scan-report:
    name: scan-report
    runs-on: ubuntu-latest
    needs: [validate]
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec and capture output
        id: tfsec
        run: |
          mkdir -p docs/scan-reports
          RUN_DATE=$(date -u +%Y-%m-%dT%H:%MZ)
          REPORT="docs/scan-reports/iac-deploy-scan-report.md"
          echo "# IaC Deploy – Security Scan Report" > "$REPORT"
          echo "" >> "$REPORT"
          echo "**Pipeline:** IaC Deploy | **Run:** ${{ github.run_id }} | **Date:** $RUN_DATE" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## tfsec (Terraform security)" >> "$REPORT"
          echo "" >> "$REPORT"
          echo '```' >> "$REPORT"
          docker run --rm -v "${{ github.workspace }}:/src" aquasec/tfsec:latest /src/${{ env.TF_WORKING_DIR }} --minimum-severity LOW --no-color 2>&1 || true >> "$REPORT"
          echo '```' >> "$REPORT"
          echo "report_path=$REPORT" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create Pull Request for scan report
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ci/scan-report-iac-deploy-${{ github.run_id }}
          delete-branch: true
          commit-message: "ci: add IaC Deploy scan report (run ${{ github.run_id }})"
          title: "[CI] IaC Deploy scan report – run ${{ github.run_id }}"
          body: |
            Auto-generated scan report from **IaC Deploy** pipeline.
            - **Workflow run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit:** ${{ github.sha }}
            - **Branch:** ${{ github.ref_name }}
            Please review and merge to add the report to the repo.

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: [validate]
    # Run on push to main or when manually triggered from main (workflow_dispatch).
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      id-token: write

    env:
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET || format('{0}-tfstate-wiz-exercise', secrets.GCP_PROJECT_ID) }}

    steps:
      - name: Check deploy secrets
        id: check_secrets
        run: |
          if [ -z "$MONGODB_ADMIN_PASSWORD" ] || [ -z "$MONGODB_APP_PASSWORD" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::notice::MONGODB_ADMIN_PASSWORD and MONGODB_APP_PASSWORD not set in this repo — skipping Terraform deploy (validate still passed). Add these secrets to run deploy from this repo, or use the wiz-iac repo for IaC deploy."
            exit 0
          fi
          if [ ${#MONGODB_ADMIN_PASSWORD} -lt 32 ] || [ ${#MONGODB_APP_PASSWORD} -lt 32 ]; then
            echo "::error::Each MongoDB secret must be at least 32 characters."
            exit 1
          fi
          echo "skip=false" >> $GITHUB_OUTPUT
        env:
          MONGODB_ADMIN_PASSWORD: ${{ secrets.MONGODB_ADMIN_PASSWORD }}
          MONGODB_APP_PASSWORD: ${{ secrets.MONGODB_APP_PASSWORD }}

      - name: Checkout
        if: steps.check_secrets.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        if: steps.check_secrets.outputs.skip != 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        if: steps.check_secrets.outputs.skip != 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Terraform
        if: steps.check_secrets.outputs.skip != 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Terraform Init (GCS backend)
        if: steps.check_secrets.outputs.skip != 'true'
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Install GKE auth plugin (for Terraform null_resource kubectl)
        if: steps.check_secrets.outputs.skip != 'true'
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Terraform Plan
        if: steps.check_secrets.outputs.skip != 'true'
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_mongodb_admin_password: ${{ secrets.MONGODB_ADMIN_PASSWORD }}
          TF_VAR_mongodb_app_password: ${{ secrets.MONGODB_APP_PASSWORD }}
        run: terraform plan -input=false -out=tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        if: steps.check_secrets.outputs.skip != 'true'
        run: terraform apply -input=false -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get application URL (after Argo CD sync)
        if: steps.check_secrets.outputs.skip != 'true'
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || true
          GKE_NAME=$(terraform output -raw gke_cluster_name 2>/dev/null || echo "wiz-exercise-gke")
          GKE_REGION=$(terraform output -raw region 2>/dev/null || echo "us-central1")
          gcloud container clusters get-credentials "$GKE_NAME" --region "$GKE_REGION" --project "${{ secrets.GCP_PROJECT_ID }}" 2>/dev/null || true
          echo "## Application URL (after app pipeline)" >> $GITHUB_STEP_SUMMARY
          for i in $(seq 1 6); do
            IP=$(kubectl get ingress -n tasky tasky -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
            if [ -n "$IP" ]; then
              echo "**Live URL:** http://$IP" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
            echo "Waiting for ingress IP... ($i/6)"
            sleep 15
          done
          echo "Run the **Phase 1 CI Gates** workflow to build/push image and deploy; app URL will appear there." >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Deploy skipped (no MongoDB secrets)
        if: steps.check_secrets.outputs.skip == 'true'
        run: |
          echo "## Deploy skipped" >> $GITHUB_STEP_SUMMARY
          echo "MONGODB_ADMIN_PASSWORD and MONGODB_APP_PASSWORD are not set in this repo. IaC **validate** passed. To run Terraform deploy from this repo, add these secrets (min 32 chars each). Otherwise use the **wiz-iac** repo for full IaC deploy."
