# Argo CD Application for Tasky (Wiz Technical Exercise V4 â€“ GitOps).
# The app repo deploys the app: Deploy workflow applies this file with repo URL, targetRevision (commit SHA), and image substituted.
# IaC installs Argo CD and creates tasky namespace + tasky-secret; this Application is applied by the app pipeline.
# Best practices applied: immutable targetRevision (SHA), ignoreDifferences for Secret + rollout, syncOptions per Argo CD docs.
# Placeholders: REPO_URL_PLACEHOLDER, TARGET_REVISION_PLACEHOLDER, IMAGE_PLACEHOLDER (replaced in Deploy workflow).
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: tasky
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    app.kubernetes.io/name: tasky
    app.kubernetes.io/part-of: wiz-exercise
spec:
  project: default
  source:
    repoURL: REPO_URL_PLACEHOLDER
    # Pinned to commit SHA by CI for immutable sync (Argo CD best practice: use tag or SHA, not HEAD).
    targetRevision: TARGET_REVISION_PLACEHOLDER
    path: kubernetes
    kustomize:
      images:
        # Replaced in Deploy workflow: tasky:latest=<artifact-registry-image>
        - tasky:latest=IMAGE_PLACEHOLDER
  destination:
    server: https://kubernetes.default.svc
    namespace: tasky
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PruneLast=true
      # Only apply when out of sync (reduces unnecessary full syncs).
      - ApplyOutOfSyncOnly=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  ignoreDifferences:
    # Ignore Secret data drift (secret is managed by IaC).
    - group: ""
      kind: Secret
      jsonPointers:
        - /data
    # Ignore rollout restarts from CI (kubectl rollout restart) so Argo CD does not revert.
    - group: apps
      kind: Deployment
      jqPathExpressions:
        - .spec.template.metadata.annotations["kubectl.kubernetes.io/restartedAt"]
